@model NAKHLA.Models.Product
@{
    ViewBag.Title = "Edit Product";
    ViewBag.PageTitle = "Edit Product";

    var categories = ViewBag.Categories as List<NAKHLA.Models.Category> ?? new List<NAKHLA.Models.Category>();
    var brands = ViewBag.Brands as List<NAKHLA.Models.Brand> ?? new List<NAKHLA.Models.Brand>();
}

<div class="page-header">
    <div>
        <h2>Edit Product: @Model.Name</h2>
        <p class="page-subtitle">Update product information</p>
    </div>
    <div class="header-actions">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form asp-action="Edit" method="post" id="editProductForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="CreatedAt" />
            <input type="hidden" asp-for="CreatedBy" />

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="Name" class="form-label">Product Name *</label>
                        <input asp-for="Name" class="form-control" required>
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="SKU" class="form-label">SKU *</label>
                        <input asp-for="SKU" class="form-control" required>
                        <span asp-validation-for="SKU" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Slug" class="form-label">URL Slug</label>
                        <input asp-for="Slug" class="form-control">
                        <span asp-validation-for="Slug" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="ShortDescription" class="form-label">Short Description</label>
                        <textarea asp-for="ShortDescription" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="ShortDescription" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="CategoryId" class="form-label">Category *</label>
                        <select asp-for="CategoryId" class="form-control" required>
                            <option value="">Select Category</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id" selected="@(category.Id == Model.CategoryId)">@category.Name</option>
                            }
                        </select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="BrandId" class="form-label">Brand</label>
                        <select asp-for="BrandId" class="form-control">
                            <option value="">Select Brand</option>
                            @foreach (var brand in brands)
                            {
                                <option value="@brand.Id" selected="@(brand.Id == Model.BrandId)">@brand.Name</option>
                            }
                        </select>
                        <span asp-validation-for="BrandId" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="Price" class="form-label">Price ($) *</label>
                                <input asp-for="Price" type="number" step="0.01" class="form-control" required>
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="CostPrice" class="form-label">Cost Price ($)</label>
                                <input asp-for="CostPrice" type="number" step="0.01" class="form-control">
                                <span asp-validation-for="CostPrice" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="StockQuantity" class="form-label">Stock Quantity *</label>
                                <input asp-for="StockQuantity" type="number" class="form-control" required>
                                <span asp-validation-for="StockQuantity" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="LowStockThreshold" class="form-label">Low Stock Alert</label>
                                <input asp-for="LowStockThreshold" type="number" class="form-control">
                                <span asp-validation-for="LowStockThreshold" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Description" class="form-label">Full Description</label>
                <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="MainImage" class="form-label">Main Image URL</label>
                        <input asp-for="MainImage" class="form-control">
                        <span asp-validation-for="MainImage" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="MetaTitle" class="form-label">Meta Title (SEO)</label>
                        <input asp-for="MetaTitle" class="form-control">
                        <span asp-validation-for="MetaTitle" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="MetaDescription" class="form-label">Meta Description (SEO)</label>
                        <textarea asp-for="MetaDescription" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="MetaDescription" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="MetaKeywords" class="form-label">Meta Keywords (SEO)</label>
                        <input asp-for="MetaKeywords" class="form-control">
                        <span asp-validation-for="MetaKeywords" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input asp-for="Status" class="form-check-input">
                        <label asp-for="Status" class="form-check-label">Active</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input asp-for="IsFeatured" class="form-check-input">
                        <label asp-for="IsFeatured" class="form-check-label">Featured Product</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input asp-for="IsBestSeller" class="form-check-input">
                        <label asp-for="IsBestSeller" class="form-check-label">Best Seller</label>
                    </div>
                </div>
            </div>

            <div class="form-actions mt-4 pt-4 border-top">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Update Product
                </button>
                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Form validation
            $('#editProductForm').validate({
                rules: {
                    Name: {
                        required: true,
                        minlength: 3
                    },
                    SKU: {
                        required: true
                    },
                    Price: {
                        required: true,
                        min: 0
                    },
                    StockQuantity: {
                        required: true,
                        min: 0
                    },
                    CategoryId: {
                        required: true
                    }
                },
                messages: {
                    Name: {
                        required: "Product name is required",
                        minlength: "Product name must be at least 3 characters"
                    },
                    SKU: {
                        required: "SKU is required"
                    },
                    Price: {
                        required: "Price is required",
                        min: "Price cannot be negative"
                    },
                    StockQuantity: {
                        required: "Stock quantity is required",
                        min: "Stock cannot be negative"
                    },
                    CategoryId: {
                        required: "Category is required"
                    }
                }
            });

            // Handle form submission via AJAX
            $('#editProductForm').on('submit', function(e) {
                e.preventDefault();

                if ($(this).valid()) {
                    const form = $(this);
                    const submitBtn = form.find('button[type="submit"]');
                    const originalText = submitBtn.html();

                    // Show loading
                    submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Updating...');
                    submitBtn.prop('disabled', true);

                    $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: form.serialize(),
                        success: function(response) {
                            if (response.success) {
                                alert('Product updated successfully!');
                                window.location.href = '/admin/products';
                            } else {
                                alert('Error: ' + response.message);
                                submitBtn.html(originalText);
                                submitBtn.prop('disabled', false);
                            }
                        },
                        error: function() {
                            alert('Error updating product');
                            submitBtn.html(originalText);
                            submitBtn.prop('disabled', false);
                        }
                    });
                }
            });
        });
    </script>
}