@model NAKHLA.Models.Category

@{
    ViewBag.Title = "Edit Category";
    // We'll make this look like a modal page
    Layout = "_AdminLayout"; // or whatever your layout is
}

<!-- Make the whole page look like a modal overlay -->
<div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1040; display: flex; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); overflow-y: auto;">

        <!-- MODAL HEADER like Brand _EditPartial.cshtml -->
        <div class="modal-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; justify-content: space-between;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 500;">Edit Category: @Model.Name</h3>
            <a asp-action="Index" class="modal-close" style="background: none; border: none; font-size: 1.25rem; color: #6c757d; cursor: pointer; text-decoration: none;">
                <i class="fas fa-times"></i>
            </a>
        </div>

        <!-- FORM like Brand _EditPartial.cshtml -->
        <form id="editCategoryForm" method="post" action="/Admin/Categories/Edit/@Model.Id">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" value="@Model.Id" />

            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Validation Summary -->
                <div class="validation-summary">
                    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger", style = "display: none;" })
                </div>

                <!-- Row 1: Name and Status -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group mb-3">
                            @Html.LabelFor(model => model.Name, "Category Name", new { @class = "form-label" })
                            @Html.TextBoxFor(model => model.Name, new {
                            @class = "form-control",
                                                        placeholder = "Enter category name",
                                                        required = "required"
                                                        })
                            @Html.ValidationMessageFor(model => model.Name, null, new { @class = "text-danger" })
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            @Html.LabelFor(model => model.Status, "Status", new { @class = "form-label" })
                            @{
                                var statusList = new SelectList(new[]
                                {
                                                        new SelectListItem { Text = "Active", Value = "Active" },
                                                        new SelectListItem { Text = "Inactive", Value = "Inactive" },
                                                        new SelectListItem { Text = "Archived", Value = "Archived" },
                                                        new SelectListItem { Text = "Draft", Value = "Draft" }
                                                        }, "Value", "Text", Model.Status);
                            }
                            @Html.DropDownListFor(model => model.Status, statusList, "Select Status", new { @class = "form-control" })
                            @Html.ValidationMessageFor(model => model.Status, null, new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group mb-3">
                    @Html.LabelFor(model => model.Description, "Description", new { @class = "form-label" })
                    @Html.TextAreaFor(model => model.Description, new {
                    @class = "form-control",
                                        rows = "3",
                                        placeholder = "Enter category description (optional)"
                                        })
                    @Html.ValidationMessageFor(model => model.Description, null, new { @class = "text-danger" })
                </div>

                <!-- Row 2: Display Order and Image URL -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            @Html.LabelFor(model => model.DisplayOrder, "Display Order", new { @class = "form-label" })
                            @Html.TextBoxFor(model => model.DisplayOrder, new {
                                                        @class = "form-control",
                                                        type = "number",
                                                        min = "0",
                                                        max = "1000",
                                                        placeholder = "0"
                                                        })
                            <small class="text-muted">Lower numbers appear first</small>
                            @Html.ValidationMessageFor(model => model.DisplayOrder, null, new { @class = "text-danger" })
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            @Html.LabelFor(model => model.ImageUrl, "Image URL", new { @class = "form-label" })
                            @Html.TextBoxFor(model => model.ImageUrl, new {
                                                        @class = "form-control",
                                                        placeholder = "https://example.com/image.jpg"
                                                        })
                            <small class="text-muted">Optional category image</small>
                            @Html.ValidationMessageFor(model => model.ImageUrl, null, new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <!-- Row 3: Slug and Icon Class -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            @Html.LabelFor(model => model.Slug, "URL Slug", new { @class = "form-label" })
                            <div class="input-group">
                                @Html.TextBoxFor(model => model.Slug, new {
                                                                @class = "form-control",
                                                                placeholder = "category-name"
                                                                })
                                <button type="button" class="btn btn-outline-secondary" onclick="generateSlug()" title="Regenerate Slug">
                                    <i class="fas fa-magic"></i>
                                </button>
                            </div>
                            <small class="text-muted">URL-friendly name (auto-generated if empty)</small>
                            @Html.ValidationMessageFor(model => model.Slug, null, new { @class = "text-danger" })
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            @Html.LabelFor(model => model.IconClass, "Icon Class", new { @class = "form-label" })
                            @Html.TextBoxFor(model => model.IconClass, new {
                                                        @class = "form-control",
                                                        placeholder = "fas fa-tag"
                                                        })
                            <small class="text-muted">Font Awesome icon class (optional)</small>
                            @Html.ValidationMessageFor(model => model.IconClass, null, new { @class = "text-danger" })
                        </div>
                    </div>
                </div>

                <!-- Meta Title -->
                <div class="form-group mb-3">
                    @Html.LabelFor(model => model.MetaTitle, "Meta Title", new { @class = "form-label" })
                    @Html.TextBoxFor(model => model.MetaTitle, new {
                                        @class = "form-control",
                                        placeholder = "SEO title for search engines"
                                        })
                    <small class="text-muted">Appears in browser tab and search results</small>
                    @Html.ValidationMessageFor(model => model.MetaTitle, null, new { @class = "text-danger" })
                </div>

                <!-- Meta Description -->
                <div class="form-group mb-4">
                    @Html.LabelFor(model => model.MetaDescription, "Meta Description", new { @class = "form-label" })
                    @Html.TextAreaFor(model => model.MetaDescription, new {
                                        @class = "form-control",
                                        rows = "2",
                                        placeholder = "SEO description for search engines"
                                        })
                    <small class="text-muted">Appears in search results (max 160 characters)</small>
                    @Html.ValidationMessageFor(model => model.MetaDescription, null, new { @class = "text-danger" })
                </div>

                <!-- Audit Information - Similar to Brand Edit.cshtml -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">Created</label>
                            <div class="form-control" style="background: #f8fafc; cursor: not-allowed;">
                                @Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                            </div>
                        </div>
                    </div>
                    @if (Model.UpdatedAt.HasValue)
                    {
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Last Updated</label>
                                <div class="form-control" style="background: #f8fafc; cursor: not-allowed;">
                                    @Model.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")
                                </div>
                            </div>
                        </div>
                    }
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">Products Count</label>
                            <div class="form-control" style="background: #f8fafc; cursor: not-allowed;">
                                @(Model.Products?.Count() ?? 0) products
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL FOOTER like Brand _EditPartial.cshtml -->
            <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 0.5rem;">
                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Form validation like Brand _EditPartial.cshtml
            $('#editCategoryForm').validate({
                rules: {
                    Name: {
                        required: true,
                        minlength: 3,
                        maxlength: 50
                    },
                    Description: {
                        maxlength: 500
                    },
                    DisplayOrder: {
                        number: true,
                        min: 0,
                        max: 1000
                    },
                    Slug: {
                        maxlength: 100
                    },
                    MetaTitle: {
                        maxlength: 150
                    },
                    MetaDescription: {
                        maxlength: 300
                    },
                    ImageUrl: {
                        url: true
                    }
                },
                messages: {
                    Name: {
                        required: "Category name is required",
                        minlength: "Category name must be at least 3 characters",
                        maxlength: "Category name cannot exceed 50 characters"
                    },
                    Description: {
                        maxlength: "Description cannot exceed 500 characters"
                    },
                    DisplayOrder: {
                        number: "Please enter a valid number",
                        min: "Display order cannot be negative",
                        max: "Display order cannot exceed 1000"
                    },
                    Slug: {
                        maxlength: "Slug cannot exceed 100 characters"
                    },
                    MetaTitle: {
                        maxlength: "Meta title cannot exceed 150 characters"
                    },
                    MetaDescription: {
                        maxlength: "Meta description cannot exceed 300 characters"
                    },
                    ImageUrl: {
                        url: "Please enter a valid URL"
                    }
                },
                errorElement: 'span',
                errorClass: 'text-danger',
                highlight: function(element) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function(element) {
                    $(element).removeClass('is-invalid');
                },
                errorPlacement: function(error, element) {
                    error.insertAfter(element);
                }
            });

            // Auto-generate slug from name
            $('#Name').on('blur', function() {
                const name = $(this).val();
                const slugField = $('#Slug');

                if (name && (!slugField.val() || slugField.val().trim() === '')) {
                    generateSlugFromName(name);
                }
            });

            // Handle form submission
            $('#editCategoryForm').on('submit', function(e) {
                e.preventDefault();

                if (!$(this).valid()) {
                    return false;
                }

                const form = this;
                const submitBtn = $(form).find('button[type="submit"]');
                const originalHtml = submitBtn.html();

                // Show loading
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Saving...');
                submitBtn.prop('disabled', true);

                $.ajax({
                    url: $(form).attr('action'),
                    type: 'POST',
                    data: $(form).serialize(),
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            alert('Category updated successfully!');
                            // Redirect to index
                            window.location.href = '/admin/categories';
                        } else {
                            // Show error
                            alert(response.error || 'Error updating category');
                            // Reset button
                            submitBtn.html(originalHtml);
                            submitBtn.prop('disabled', false);
                        }
                    },
                    error: function() {
                        alert('Error updating category');
                        submitBtn.html(originalHtml);
                        submitBtn.prop('disabled', false);
                    }
                });

                return false;
            });
        });

        // Generate slug function
        function generateSlug() {
            const name = $('#Name').val();
            if (name) {
                const slug = name
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[\s_-]+/g, '-')
                    .replace(/^-+|-+$/g, '');

                $('#Slug').val(slug);
            } else {
                alert('Please enter a category name first');
            }
        }

        function generateSlugFromName(name) {
            const slug = name
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');

            $('#Slug').val(slug);
        }
    </script>
}