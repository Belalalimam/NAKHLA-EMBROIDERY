@model List<NAKHLA.Models.Category>
@{
    ViewBag.Title = "Category Management";
    ViewBag.PageTitle = "Categories";
    ViewBag.Subtitle = "Manage product categories";
}

<!-- =========================================================================== -->
<!-- MOBILE TABLE HINT -->
<!-- =========================================================================== -->
<div class="mobile-scroll-hint" style="display: none; background: #f1f5f9; padding: 8px; text-align: center; color: #64748b; font-size: 12px; border-radius: 6px; margin-bottom: 15px;">
    <i class="fas fa-arrows-left-right"></i> Swipe horizontally to view all columns
</div>

<!-- =========================================================================== -->
<!-- PAGE HEADER SECTION -->
<!-- =========================================================================== -->
<div class="page-header">
    <div>
        <h2>Product Categories</h2>
        <p class="page-subtitle">Organize your products into categories</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary">
            <i class="fas fa-filter"></i>
            <span class="desktop-text">Filter</span>
        </button>
        <a href="/admin/categories/create" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span class="desktop-text">Add Category</span>
        </a>
    </div>
</div>

<!-- =========================================================================== -->
<!-- STATS CARDS SECTION -->
<!-- =========================================================================== -->
<div class="stats-container">
    @{
        var activeCount = Model.Count(c => c.Status == NAKHLA.Models.CategoryStatus.Active);
        var totalProducts = Model.Sum(c => c.Products?.Count ?? 0);
        var avgProducts = Model.Count > 0 ? totalProducts / Model.Count : 0;
    }

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Categories</div>
            <div class="stat-icon">
                <i class="fas fa-tags"></i>
            </div>
        </div>
        <div class="stat-value">@Model.Count</div>
        <div class="stat-desc">All categories</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Active Categories</div>
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="stat-value">@activeCount</div>
        <div class="stat-desc">Visible on website</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Products</div>
            <div class="stat-icon">
                <i class="fas fa-box"></i>
            </div>
        </div>
        <div class="stat-value">@totalProducts</div>
        <div class="stat-desc">Across all categories</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Avg. Products/Category</div>
            <div class="stat-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
        </div>
        <div class="stat-value">@avgProducts</div>
        <div class="stat-desc">Per category</div>
    </div>
</div>

<!-- =========================================================================== -->
<!-- CATEGORIES TABLE SECTION -->
<!-- =========================================================================== -->
<div class="data-table-container">
    <div class="table-header">
        <h2>All Categories</h2>
        <div class="table-actions">
            <button class="table-action" onclick="exportAllCategories()">
                <i class="fas fa-file-export"></i>
                <span class="desktop-text">Export All</span>
            </button>
            <button class="table-action" onclick="window.print()">
                <i class="fas fa-print"></i>
                <span class="desktop-text">Print</span>
            </button>
            <button class="table-action" onclick="refreshCategories()">
                <i class="fas fa-sync-alt"></i>
                <span class="desktop-text">Refresh</span>
            </button>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                </th>
                <th data-sortable="true">Category Name <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Products <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Status <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Created <i class="fas fa-sort"></i></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var category in Model)
                {
                    <tr class="table-row" data-item-id="@category.Id" onclick="selectRow(event, this)">
                        <td>
                            <input type="checkbox" class="row-select" value="@category.Id" onchange="updateSelection(this)">
                        </td>
                        <td>
                            <div class="customer-name">@category.Name</div>
                            <div class="text-muted">@(category.Description ?? "No description")</div>
                        </td>
                        <td>
                            <span class="badge badge-primary">@(category.Products?.Count ?? 0) products</span>
                        </td>
                        <td>
                            @{
                                var statusClass = category.Status.ToString().ToLowerInvariant();
                                var statusText = category.Status.ToString();
                            }
                            <span class="status-dot dot-@statusClass"></span>
                            <span class="mobile-text">@statusText</span>
                        </td>
                        <td>
                            <div class="order-date">@category.CreatedAt.ToString("dd MMM yyyy")</div>
                        </td>
                        <td onclick="event.stopPropagation()">
                            <div class="row-actions">
                                <button class="row-action view" onclick="loadViewModal('@category.Id', event)">
                                    <i class="fas fa-eye"></i>
                                    <span class="desktop-text">View</span>
                                </button>
                                <button class="row-action edit" onclick="loadEditModal('@category.Id', event)">
                                    <i class="fas fa-edit"></i>
                                    <span class="desktop-text">Edit</span>
                                </button>
                                <button class="row-action delete" onclick="deleteCategory('@category.Id', '@category.Name.Replace("'", "\\'")', event)">
                                    <i class="fas fa-trash"></i>
                                    <span class="desktop-text">Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-inbox fa-3x text-muted"></i>
                            <h4>No Categories Found</h4>
                            <p>Get started by creating your first category.</p>
                            <a href="/admin/categories/create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add First Category
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- =========================================================================== -->
    <!-- PAGINATION SECTION -->
    <!-- =========================================================================== -->
    <nav aria-label="Page navigation example ">
        <ul class="pagination d-flex justify-content-center">
            @if (ViewBag.currentPage > 1)
            {
                <li class="page-item"><a class="page-link" href="/admin/categories?page=@(ViewBag.currentPage - 1)">Previous</a></li>
            }

            @for (var i = 1; i <= ViewBag.totalHodsOfPage; i++)
            {
                if (i == ViewBag.currentPage)
                {
                    <li class="page-item active"><a class="page-link" href="/admin/categories?page=@i">@i</a></li>
                }
                else
                {
                    <li class="page-item"><a class="page-link" href="/admin/categories?page=@i">@i</a></li>
                }
            }

            @if (ViewBag.currentPage != ViewBag.totalHodsOfPage && Model.Any())
            {
                <li class="page-item"><a class="page-link" href="/admin/categories?page=@(ViewBag.currentPage + 1)">Next</a></li>
            }
        </ul>
    </nav>
</div>

<!-- =========================================================================== -->
<!-- SELECTION ACTIONS BAR -->
<!-- =========================================================================== -->
<div class="selection-actions" id="selectionActions">
    <div class="selected-count">
        <span id="selectedCount">0</span> categories selected
    </div>
    <div class="selection-buttons">
        <button class="btn btn-secondary btn-sm" onclick="exportSelectedCategories()">
            <i class="fas fa-file-export"></i>
            <span class="desktop-text">Export</span>
        </button>
        <button class="btn btn-danger btn-sm" onclick="deleteSelectedCategories()">
            <i class="fas fa-trash"></i>
            <span class="desktop-text">Delete</span>
        </button>
        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
            <i class="fas fa-times"></i>
            <span class="desktop-text">Clear</span>
        </button>
    </div>
</div>

<!-- =========================================================================== -->
<!-- MODAL CONTAINER -->
<!-- =========================================================================== -->
<div id="categoryModalContainer" class="modal" style="display: none;">
    <div class="modal-content">
        <!-- Content will be loaded dynamically via AJAX -->
    </div>
</div>

@section Scripts {
    <script>
        // ===========================================================================
        // INITIALIZATION
        // ===========================================================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Categories page loaded');
            initCategoriesPage();
            setupModalEvents();
        });

        function initCategoriesPage() {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    updateSelection(this);
                });
            });
        }

        // ===========================================================================
        // MODAL FUNCTIONS (VIEW/EDIT)
        // ===========================================================================

        function loadEditModal(categoryId, event) {
            if (event) event.stopPropagation();

            const modalContainer = document.getElementById('categoryModalContainer');
            const modalContent = modalContainer.querySelector('.modal-content');
            modalContent.innerHTML = '<div class="modal-loading">Loading edit form...</div>';
            modalContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            console.log('Loading edit form for category ID:', categoryId);

            $.ajax({
                url: '/Admin/Categories/Edit/' + categoryId,
                type: 'GET',
                success: function(response) {
                    console.log('Edit form loaded successfully');
                    const tempDiv = $('<div>').html(response);

                    if (tempDiv.find('.modal-header').length > 0 ||
                        response.includes('modal-header') ||
                        response.includes('form-control')) {
                        modalContent.innerHTML = response;
                    } else {
                        modalContent.innerHTML = `
                            <div class="modal-header">
                                <h3>Edit Category</h3>
                                <button type="button" class="modal-close" onclick="closeModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${response}
                            </div>
                        `;
                    }

                    setupModalEvents();
                    attachEditFormHandlers();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading edit form:', error);
                    modalContent.innerHTML = `
                        <div class="modal-error">
                            <h4>Error Loading Edit Form</h4>
                            <p>Status: ${xhr.status} - ${xhr.statusText}</p>
                            <p>Error: ${error}</p>
                            <button class="btn btn-primary mt-3" onclick="closeModal()">Close</button>
                        </div>`;
                }
            });
        }

        function loadViewModal(categoryId, event) {
            if (event) event.stopPropagation();

            console.log('Loading category details for ID:', categoryId);

            const modalContainer = document.getElementById('categoryModalContainer');
            const modalContent = modalContainer.querySelector('.modal-content');
            modalContent.innerHTML = '<div class="modal-loading">Loading category details...</div>';
            modalContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            $.ajax({
                url: '/Admin/Categories/Details/' + categoryId,
                type: 'GET',
                success: function(response) {
                    console.log('Success! Response received');

                    if (response.trim().startsWith('<') || response.includes('modal-header')) {
                        modalContent.innerHTML = response;
                    } else {
                        modalContent.innerHTML = `
                            <div class="modal-header">
                                <h3>Category Details</h3>
                                <button type="button" class="modal-close" onclick="closeModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${response}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
                            </div>
                        `;
                    }

                    setupModalEvents();
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error
                    });

                    if (xhr.status === 404) {
                        modalContent.innerHTML = `
                            <div class="modal-error">
                                <h4>Category Not Found</h4>
                                <p>The category with ID ${categoryId} was not found.</p>
                                <p>It may have been deleted or the URL is incorrect.</p>
                                <button class="btn btn-primary mt-3" onclick="closeModal()">Close</button>
                            </div>`;
                    } else {
                        modalContent.innerHTML = `
                            <div class="modal-error">
                                <h4>Error Loading Details</h4>
                                <p><strong>Status:</strong> ${xhr.status} - ${xhr.statusText}</p>
                                <p><strong>Error:</strong> ${error}</p>
                                <p>Please check if the Details action exists in your controller.</p>
                                <button class="btn btn-primary mt-3" onclick="closeModal()">Close</button>
                            </div>`;
                    }
                }
            });
        }

        function closeModal() {
            const modalContainer = document.getElementById('categoryModalContainer');
            if (modalContainer) {
                modalContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function setupModalEvents() {
            const modalContainer = document.getElementById('categoryModalContainer');
            if (!modalContainer) return;

            modalContainer.addEventListener('click', function(e) {
                if (e.target === this || e.target.closest('.modal-close')) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modalContainer.style.display === 'flex') {
                    closeModal();
                }
            });

            const modalContent = modalContainer.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        function attachEditFormHandlers() {
            const editForm = document.getElementById('editCategoryForm');
            if (editForm) {
                console.log('Edit form found, attaching submit handler');

                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Edit form submitted');

                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    submitBtn.disabled = true;

                    $.ajax({
                        url: this.action,
                        type: 'POST',
                        data: $(this).serialize(),
                        success: function(response) {
                            console.log('Edit response:', response);

                            if (response.success) {
                                alert(response.message || 'Category updated successfully!');
                                closeModal();
                                window.location.reload();
                            } else {
                                if (response.error) {
                                    alert('Error: ' + response.error);
                                } else {
                                    const modalContent = document.querySelector('#categoryModalContainer .modal-content');
                                    modalContent.innerHTML = response;
                                    attachEditFormHandlers();
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Edit AJAX error:', error);
                            alert('Error updating category. Please try again.');
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        },
                        complete: function() {
                            if (submitBtn.disabled) {
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                            }
                        }
                    });
                });
            } else {
                console.log('Edit form not found');
            }
        }

        // ===========================================================================
        // DELETE FUNCTIONS
        // ===========================================================================

        function deleteCategory(categoryId, categoryName, event) {
            if (!confirm(`Are you sure you want to delete "${categoryName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            console.log('Deleting category:', categoryId);

            const deleteBtn = event.target.closest('.delete');
            if (deleteBtn) {
                const originalHtml = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                deleteBtn.disabled = true;
            }

            const token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '/Admin/Categories/Delete/' + categoryId,
                type: 'POST',
                headers: {
                    'RequestVerificationToken': token
                },
                data: {
                    __RequestVerificationToken: token,
                    id: categoryId
                },
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                success: function(response) {
                    console.log('Delete response:', response);

                    if (response.success) {
                        alert(response.message || 'Category deleted successfully!');

                        const row = document.querySelector(`tr[data-item-id="${categoryId}"]`);
                        if (row) {
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';

                            setTimeout(() => {
                                row.remove();
                                updateSelectionUI();

                                if (document.querySelectorAll('.data-table tbody tr').length === 0) {
                                    showEmptyState();
                                }
                            }, 300);
                        }
                    } else {
                        alert(response.message || 'Error deleting category.');

                        if (deleteBtn) {
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i><span class="desktop-text">Delete</span>';
                            deleteBtn.disabled = false;
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Delete error:', error);
                    console.error('Response:', xhr.responseText);
                    alert('Error deleting category. Please check console for details.');

                    if (deleteBtn) {
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i><span class="desktop-text">Delete</span>';
                        deleteBtn.disabled = false;
                    }
                }
            });
        }

        function deleteSelectedCategories() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Please select at least one category to delete.');
                return;
            }

            const categoryIds = Array.from(selected).map(checkbox => checkbox.value);
            const count = selected.length;

            if (!confirm(`Are you sure you want to delete ${count} selected category(s)?\n\nThis action cannot be undone.`)) {
                return;
            }

            const deleteBtn = document.querySelector('#selectionActions .btn-danger');
            if (deleteBtn) {
                const originalHtml = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                deleteBtn.disabled = true;
            }

            const token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '/Admin/Categories/DeleteMultiple',
                type: 'POST',
                headers: {
                    'RequestVerificationToken': token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    ids: categoryIds,
                    __RequestVerificationToken: token
                }),
                success: function(response) {
                    console.log('Bulk delete response:', response);

                    if (response.success) {
                        alert(response.message || `${count} category(s) deleted successfully!`);

                        selected.forEach(checkbox => {
                            const row = checkbox.closest('tr');
                            if (row) {
                                row.style.transition = 'opacity 0.3s';
                                row.style.opacity = '0';

                                setTimeout(() => {
                                    row.remove();
                                }, 300);
                            }
                        });

                        setTimeout(() => {
                            clearSelection();

                            if (document.querySelectorAll('.data-table tbody tr').length === 0) {
                                showEmptyState();
                            }
                        }, 400);
                    } else {
                        alert(response.message || 'Error deleting categories.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Bulk delete error:', error);
                    alert('Error deleting categories. Please try again.');
                },
                complete: function() {
                    if (deleteBtn) {
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i><span class="desktop-text">Delete</span>';
                        deleteBtn.disabled = false;
                    }
                }
            });
        }

        function showEmptyState() {
            const tbody = document.querySelector('.data-table tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-inbox fa-3x text-muted"></i>
                                <h4>No Categories Found</h4>
                                <p>Get started by creating your first category.</p>
                                <a href="/admin/categories/create" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add First Category
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function getAntiForgeryToken() {
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenElement) {
                return tokenElement.value;
            }

            const form = document.querySelector('form input[name="__RequestVerificationToken"]');
            if (form) {
                return form.value;
            }

            console.warn('Anti-forgery token not found');
            return '';
        }

        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = getAntiForgeryToken();
                if (token) {
                    xhr.setRequestHeader('RequestVerificationToken', token);
                }
            }
        });

        // ===========================================================================
        // OTHER CATEGORY OPERATIONS
        // ===========================================================================

        function exportSelectedCategories() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Please select at least one category to export.');
                return;
            }

            const categoryIds = Array.from(selected).map(checkbox => checkbox.value);
            const count = selected.length;

            const exportBtn = document.querySelector('#selectionActions .btn-secondary');
            const originalText = exportBtn ? exportBtn.innerHTML : '';

            if (exportBtn) {
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                exportBtn.disabled = true;
            }

            setTimeout(() => {
                alert(`Exporting ${count} selected categories...\nCategory IDs: ${categoryIds.join(', ')}`);

                if (exportBtn) {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }
            }, 1000);
        }

        function exportAllCategories() {
            const allCategoryIds = Array.from(document.querySelectorAll('.row-select')).map(cb => cb.value);

            if (allCategoryIds.length === 0) {
                alert('No categories to export.');
                return;
            }

            alert(`Exporting all ${allCategoryIds.length} categories...\nCategory IDs: ${allCategoryIds.join(', ')}`);
        }

        function refreshCategories() {
            const refreshBtn = document.querySelector('.table-action:nth-child(3)');
            const originalText = refreshBtn ? refreshBtn.innerHTML : '';

            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                refreshBtn.disabled = true;
            }

            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // ===========================================================================
        // SELECTION MANAGEMENT FUNCTIONS
        // ===========================================================================

        let selectedItems = new Set();

        function selectRow(event, row) {
            if (event.target.type === 'checkbox' ||
                event.target.closest('.row-actions') ||
                event.target.tagName === 'A') {
                return;
            }

            const checkbox = row.querySelector('.row-select');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelection(checkbox);
            }
        }

        function updateSelection(checkbox) {
            const itemId = checkbox.value;

            if (checkbox.checked) {
                selectedItems.add(itemId);
                checkbox.closest('tr').classList.add('selected');
            } else {
                selectedItems.delete(itemId);
                checkbox.closest('tr').classList.remove('selected');
                const selectAll = document.getElementById('selectAll');
                if (selectAll) selectAll.checked = false;
            }

            updateSelectionUI();
        }

        function toggleSelectAll(selectAllCheckbox) {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                updateSelection(checkbox);
            });
        }

        function updateSelectionUI() {
            const count = selectedItems.size;
            const selectedCountEl = document.getElementById('selectedCount');
            const actionsBar = document.getElementById('selectionActions');

            if (selectedCountEl) {
                selectedCountEl.textContent = count;
            }

            if (actionsBar) {
                if (count > 0) {
                    actionsBar.classList.add('active');
                } else {
                    actionsBar.classList.remove('active');
                }
            }
        }

        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.checked = false;
                cb.closest('tr')?.classList.remove('selected');
            });
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = false;
            updateSelectionUI();
        }

        // ===========================================================================
        // MOBILE FUNCTIONS
        // ===========================================================================

        function isMobile() {
            return window.innerWidth <= 768;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const mobileHint = document.querySelector('.mobile-scroll-hint');
            if (mobileHint && isMobile()) {
                mobileHint.style.display = 'block';
            }

            window.addEventListener('resize', function() {
                if (mobileHint) {
                    mobileHint.style.display = isMobile() ? 'block' : 'none';
                }
            });
        });
    </script>
}