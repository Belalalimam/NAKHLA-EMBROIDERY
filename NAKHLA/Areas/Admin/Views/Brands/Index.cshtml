@model List<Brand>
@{
    // ===========================================================================
    // PAGE METADATA SECTION
    // ===========================================================================
    // This section defines metadata for the page layout and title display
    ViewBag.Title = "Brand Management";
    ViewBag.PageTitle = "Brands";
    ViewBag.Subtitle = "Manage product brands";
}

<!-- =========================================================================== -->
<!-- MOBILE TABLE HINT -->
<!-- =========================================================================== -->
<!--
    This hint is only visible on mobile devices to inform users they can swipe
    horizontally to see all table columns on smaller screens
-->
<div class="mobile-scroll-hint" style="display: none; background: #f1f5f9; padding: 8px; text-align: center; color: #64748b; font-size: 12px; border-radius: 6px; margin-bottom: 15px;">
    <i class="fas fa-arrows-left-right"></i> Swipe horizontally to view all columns
</div>

<!-- =========================================================================== -->
<!-- PAGE HEADER SECTION -->
<!-- =========================================================================== -->
<!--
    Contains the main page title, subtitle, and action buttons.
    The "Add Brand" button now navigates to /admin/brands/create instead of opening a modal
-->
<div class="page-header">
    <div>
        <h2>Product Brands</h2>
        <p class="page-subtitle">Manage brands for your products</p>
    </div>
    <div class="header-actions">
        <!-- Filter button (functionality not implemented yet) -->
        <button class="btn btn-secondary">
            <i class="fas fa-filter"></i>
            <span class="desktop-text">Filter</span>
        </button>
        <!-- "Add Brand" button - Navigates to create page -->
        <a href="/admin/brands/create" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span class="desktop-text">Add Brand</span>
        </a>
    </div>
</div>

<!-- =========================================================================== -->
<!-- STATS CARDS SECTION -->
<!-- =========================================================================== -->
<!--
    Displays key metrics and statistics about brands.
    Currently uses static data but can be connected to real database values
-->
<div class="stats-container">
    <!-- Total Brands Card -->
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Brands</div>
            <div class="stat-icon">
                <i class="fas fa-copyright"></i>
            </div>
        </div>
        <div class="stat-value">18</div>
        <div class="stat-desc">+2 from last month</div>
        <div class="stat-trend trend-up">
            <i class="fas fa-arrow-up"></i> 11.1%
        </div>
    </div>

    <!-- Active Brands Card -->
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Active Brands</div>
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="stat-value">15</div>
        <div class="stat-desc">Visible on website</div>
    </div>

    <!-- Featured Brands Card -->
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Featured Brands</div>
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
        </div>
        <div class="stat-value">8</div>
        <div class="stat-desc">Highlighted on homepage</div>
    </div>

    <!-- Products per Brand Card -->
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Products/Brand</div>
            <div class="stat-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
        </div>
        <div class="stat-value">69</div>
        <div class="stat-desc">Average products per brand</div>
    </div>
</div>

<!-- =========================================================================== -->
<!-- BRANDS TABLE SECTION -->
<!-- =========================================================================== -->
<!--
    Main data table displaying all brands with sorting, selection, and action buttons.
    Includes pagination for navigating through multiple pages of results
-->
<div class="data-table-container">
    <!-- Table header with title and action buttons -->
    <div class="table-header">
        <h2>All Brands</h2>
        <div class="table-actions">
            <!-- Export All button -->
            <button class="table-action" onclick="exportAllBrands()">
                <i class="fas fa-file-export"></i>
                <span class="desktop-text">Export All</span>
            </button>
            <!-- Print button -->
            <button class="table-action" onclick="window.print()">
                <i class="fas fa-print"></i>
                <span class="desktop-text">Print</span>
            </button>
            <!-- Refresh button -->
            <button class="table-action" onclick="refreshBrands()">
                <i class="fas fa-sync-alt"></i>
                <span class="desktop-text">Refresh</span>
            </button>
        </div>
    </div>

    <!-- Main brands table -->
    <table class="data-table">
        <thead>
            <tr>
                <!-- Checkbox column for selecting multiple rows -->
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                </th>
                <!-- Sortable columns with sort icons -->
                <th data-sortable="true">Brand Name <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Products <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Status <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Website <i class="fas fa-sort"></i></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                <!-- Loop through each brand in the model -->
                @foreach (var item in Model)
                {
                    <!-- Table row for each brand with click handler for selection -->
                    <tr class="table-row" data-item-id="@item.Id" onclick="selectRow(event, this)">
                        <!-- Checkbox for row selection -->
                        <td>
                            <input type="checkbox" class="row-select" value="@item.Id" onchange="updateSelection(this)">
                        </td>
                        <!-- Brand name and description -->
                        <td>
                            <div class="customer-name">@item.Name</div>
                            <div class="text-muted">@(item.Description ?? "No description")</div>
                        </td>
                        <!-- Products count with badge -->
                        <td>
                            <span class="badge badge-primary">@(item.Products?.Count() ?? 0) products</span>
                        </td>
                        <!-- Status with colored dot indicator -->
                        <td>
                            @if (item.Status == "Active")
                            {
                                <span class="status-dot dot-active"></span>
                            }
                            else
                            {
                                <span class="status-dot dot-inactive"></span>
                            }
                            <span class="mobile-text">@item.Status</span>
                        </td>
                        <!-- Website link with safe URL parsing -->
                        <td>
                            <div class="website-link">
                                @if (!string.IsNullOrEmpty(item.Website))
                                {
                                    <a href="@item.Website" target="_blank" onclick="event.stopPropagation()">
                                        @{
                                            // Safely extract and display domain name from URL
                                            if (!string.IsNullOrEmpty(item.Website) &&
                                            Uri.TryCreate(item.Website, UriKind.Absolute, out Uri uri))
                                            {
                                                @uri.Host
                                            }
                                            else
                                            {
                                                <span>Website</span>
                                            }
                                        }
                                    </a>
                                }
                                else
                                {
                                    <span class="text-muted">Not specified</span>
                                }
                            </div>
                        </td>
                        <!-- Action buttons (View, Edit, Delete) -->
                        <td onclick="event.stopPropagation()">
                            <div class="row-actions">
                                <!-- View button - opens modal with brand details -->
                                <button class="row-action view" onclick="loadViewModal('@item.Id', event)">
                                    <i class="fas fa-eye"></i>
                                    <span class="desktop-text">View</span>
                                </button>
                                <!-- Edit button - opens modal with edit form -->
                                <button class="row-action edit" onclick="loadEditModal('@item.Id', event)">
                                    <i class="fas fa-edit"></i>
                                    <span class="desktop-text">Edit</span>
                                </button>
                                <!-- Delete button - shows confirmation then deletes brand -->
                                <button class="row-action delete" onclick="deleteBrand('@item.Id', '@item.Name.Replace("'", "\\'")', event)">
                                    <i class="fas fa-trash"></i>
                                    <span class="desktop-text">Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <!-- Empty state when no brands exist -->
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-inbox fa-3x text-muted"></i>
                            <h4>No Brands Found</h4>
                            <p>Get started by creating your first brand.</p>
                            <a href="/admin/brands/create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add First Brand
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- =========================================================================== -->
    <!-- PAGINATION SECTION -->
    <!-- =========================================================================== -->
    <!--
        Pagination controls for navigating between pages of brands.
        Shows previous/next buttons and numbered page links
    -->
    <nav aria-label="Page navigation example ">
        <ul class="pagination d-flex justify-content-center">
            <!-- Previous page link -->
            @if (ViewBag.currentPage > 1)
            {
                <li class="page-item"><a class="page-link" href="/admin/brands?page=@(ViewBag.currentPage - 1)">Previous</a></li>
            }

            <!-- Page number links -->
            @for (var i = 1; i <= ViewBag.totalHodsOfPage; i++)
            {
                if (i == ViewBag.currentPage)
                {
                    <!-- Current page (active) -->
                    <li class="page-item active"><a class="page-link" href="/admin/brands?page=@i">@i</a></li>
                }
                else
                {
                    <!-- Other pages -->
                    <li class="page-item"><a class="page-link" href="/admin/brands?page=@i">@i</a></li>
                }
            }

            <!-- Next page link -->
            @if (ViewBag.currentPage != ViewBag.totalHodsOfPage && Model.Any())
            {
                <li class="page-item"><a class="page-link" href="/admin/brands?page=@(ViewBag.currentPage + 1)">Next</a></li>
            }
        </ul>
    </nav>
</div>

<!-- =========================================================================== -->
<!-- SELECTION ACTIONS BAR -->
<!-- =========================================================================== -->
<!--
    Appears when one or more brands are selected.
    Provides actions for the selected items (export, delete, clear)
-->
<div class="selection-actions" id="selectionActions">
    <div class="selected-count">
        <span id="selectedCount">0</span> brands selected
    </div>
    <div class="selection-buttons">
        <!-- Export selected brands -->
        <button class="btn btn-secondary btn-sm" onclick="exportSelectedBrands()">
            <i class="fas fa-file-export"></i>
            <span class="desktop-text">Export</span>
        </button>
        <!-- Delete selected brands -->
        <button class="btn btn-danger btn-sm" onclick="deleteSelectedBrands()">
            <i class="fas fa-trash"></i>
            <span class="desktop-text">Delete</span>
        </button>
        <!-- Clear selection -->
        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
            <i class="fas fa-times"></i>
            <span class="desktop-text">Clear</span>
        </button>
    </div>
</div>

<!-- =========================================================================== -->
<!-- MODAL CONTAINER -->
<!-- =========================================================================== -->
<!--
    Modal container for View and Edit operations.
    Content is loaded dynamically via AJAX when buttons are clicked
-->
<div id="brandModalContainer" class="modal" style="display: none;">
    <div class="modal-content">
        <!-- Content will be loaded dynamically via AJAX -->
    </div>
</div>

<!-- =========================================================================== -->
<!-- JAVASCRIPT SECTION -->
<!-- =========================================================================== -->
@section Scripts {
    <script>
        // ===========================================================================
        // INITIALIZATION
        // ===========================================================================

        /**
         * Initializes the page when DOM is fully loaded
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Brands page loaded');
            initBrandsPage();
            setupModalEvents();
        });

        /**
         * Initializes brand-specific functionality
         * Sets up event listeners for checkboxes
         */
        function initBrandsPage() {
            // Add event listeners to all row selection checkboxes
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    updateSelection(this);
                });
            });
        }

        // ===========================================================================
        // MODAL FUNCTIONS (VIEW/EDIT)
        // ===========================================================================

        /**
         * Loads the edit modal for a specific brand
         * param {number} brandId - The ID of the brand to edit
         * param {Event} event - The click event
         */
        function loadEditModal(brandId, event) {
            if (event) event.stopPropagation();

            const modalContainer = document.getElementById('brandModalContainer');
            const modalContent = modalContainer.querySelector('.modal-content');
            modalContent.innerHTML = '<div class="modal-loading">Loading edit form...</div>';
            modalContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            console.log('Loading edit form for brand ID:', brandId);

            // Load Edit.cshtml with brand data via AJAX
            $.ajax({
                url: '/Admin/Brands/Edit/' + brandId,
                type: 'GET',
                success: function(response) {
                    console.log('Edit form loaded successfully');
                    const tempDiv = $('<div>').html(response);

                    // Check if we got proper modal content
                    if (tempDiv.find('.modal-header').length > 0 ||
                        response.includes('modal-header') ||
                        response.includes('form-control')) {
                        modalContent.innerHTML = response;
                    } else {
                        // Wrap the response in modal structure
                        modalContent.innerHTML = `
                            <div class="modal-header">
                                <h3>Edit Brand</h3>
                                <button type="button" class="modal-close" onclick="closeModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${response}
                            </div>
                        `;
                    }

                    setupModalEvents();
                    attachEditFormHandlers(); // Attach form submission handler
                },
                error: function(xhr, status, error) {
                    console.error('Error loading edit form:', error);
                    modalContent.innerHTML = `
                        <div class="modal-error">
                            <h4>Error Loading Edit Form</h4>
                            <p>Status: ${xhr.status} - ${xhr.statusText}</p>
                            <p>Error: ${error}</p>
                            <button class="btn btn-primary mt-3" onclick="closeModal()">Close</button>
                        </div>`;
                }
            });
        }

        /**
         * Loads the view modal for a specific brand
         * param {number} brandId - The ID of the brand to view
         * param {Event} event - The click event
         */
        function loadViewModal(brandId, event) {
            if (event) event.stopPropagation();

            console.log('Loading brand details for ID:', brandId);

            const modalContainer = document.getElementById('brandModalContainer');
            const modalContent = modalContainer.querySelector('.modal-content');
            modalContent.innerHTML = '<div class="modal-loading">Loading brand details...</div>';
            modalContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Make AJAX request to get brand details
            $.ajax({
                url: '/Admin/Brands/Details/' + brandId,
                type: 'GET',
                success: function(response) {
                    console.log('Success! Response received');

                    // If we get a partial view, display it directly
                    if (response.trim().startsWith('<') || response.includes('modal-header')) {
                        modalContent.innerHTML = response;
                    } else {
                        // Wrap simple responses in modal structure
                        modalContent.innerHTML = `
                            <div class="modal-header">
                                <h3>Brand Details</h3>
                                <button type="button" class="modal-close" onclick="closeModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                ${response}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
                            </div>
                        `;
                    }

                    // Re-setup modal events for the new content
                    setupModalEvents();
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error
                    });

                    if (xhr.status === 404) {
                        modalContent.innerHTML = `
                            <div class="modal-error">
                                <h4>Brand Not Found</h4>
                                <p>The brand with ID ${brandId} was not found.</p>
                                <p>It may have been deleted or the URL is incorrect.</p>
                                <button class="btn btn-primary mt-3" onclick="closeModal()">Close</button>
                            </div>`;
                    } else {
                        modalContent.innerHTML = `
                            <div class="modal-error">
                                <h4>Error Loading Details</h4>
                                <p><strong>Status:</strong> ${xhr.status} - ${xhr.statusText}</p>
                                <p><strong>Error:</strong> ${error}</p>
                                <p>Please check if the Details action exists in your controller.</p>
                                <button class="btn btn-primary mt-3" onclick="closeModal()">Close</button>
                            </div>`;
                    }
                }
            });
        }

        /**
         * Closes the modal
         */
        function closeModal() {
            const modalContainer = document.getElementById('brandModalContainer');
            if (modalContainer) {
                modalContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        /**
         * Sets up event listeners for the modal
         * - Close on backdrop click
         * - Close on Escape key
         * - Prevent clicks inside modal from closing it
         */
        function setupModalEvents() {
            const modalContainer = document.getElementById('brandModalContainer');
            if (!modalContainer) return;

            // Close on backdrop click
            modalContainer.addEventListener('click', function(e) {
                if (e.target === this || e.target.closest('.modal-close')) {
                    closeModal();
                }
            });

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modalContainer.style.display === 'flex') {
                    closeModal();
                }
            });

            // Prevent clicks inside modal content from closing modal
            const modalContent = modalContainer.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        /**
         * Attaches form submission handlers to the edit form
         * Handles AJAX submission and response processing
         */
        function attachEditFormHandlers() {
            // Handle edit form submission
            const editForm = document.getElementById('editBrandForm');
            if (editForm) {
                console.log('Edit form found, attaching submit handler');

                // Handle checkbox to ensure proper value submission
                const checkbox = editForm.querySelector('input[name="IsFeatured"][type="checkbox"]');
                const hiddenCheckbox = editForm.querySelector('input[name="IsFeatured"][type="hidden"]');

                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (hiddenCheckbox) {
                            hiddenCheckbox.value = this.checked ? 'false' : 'false';
                        }
                    });
                }

                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Edit form submitted');

                    // Show loading state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    submitBtn.disabled = true;

                    // Fix checkbox value for submission
                    if (checkbox) {
                        checkbox.value = checkbox.checked ? 'true' : 'false';
                    }

                    $.ajax({
                        url: this.action,
                        type: 'POST',
                        data: $(this).serialize(),
                        success: function(response) {
                            console.log('Edit response:', response);

                            if (response.success) {
                                // Show success message
                                alert(response.message || 'Brand updated successfully!');
                                closeModal();
                                // Reload the page to show updated data
                                window.location.reload();
                            } else {
                                // Show validation errors or error message
                                if (response.error) {
                                    alert('Error: ' + response.error);
                                } else {
                                    // Assume response contains HTML with validation errors
                                    const modalContent = document.querySelector('#brandModalContainer .modal-content');
                                    modalContent.innerHTML = response;
                                    // Re-attach handlers to the new form
                                    attachEditFormHandlers();
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Edit AJAX error:', error);
                            alert('Error updating brand. Please try again.');

                            // Reset button
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        },
                        complete: function() {
                            // Reset button if not already reset
                            if (submitBtn.disabled) {
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                            }
                        }
                    });
                });
            } else {
                console.log('Edit form not found');
            }
        }

        // ===========================================================================
        // DELETE FUNCTIONS
        // ===========================================================================

        /**
         * Deletes a single brand after confirmation
         * param {number} brandId - The ID of the brand to delete
         * param {string} brandName - The name of the brand (for confirmation message)
         * param {Event} event - The click event
         */
        function deleteBrand(brandId, brandName, event) {
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete "${brandName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            console.log('Deleting brand:', brandId);

            // Show loading on the delete button
            const deleteBtn = event.target.closest('.delete');
            if (deleteBtn) {
                const originalHtml = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                deleteBtn.disabled = true;
            }

            // Get anti-forgery token for security
            const token = $('input[name="__RequestVerificationToken"]').val();

            // FIX FOR DELETE: Make sure we're using the correct content type
            // Send AJAX request to delete from database
            $.ajax({
                url: '/Admin/Brands/Delete/' + brandId,
                type: 'POST',
                headers: {
                    'RequestVerificationToken': token
                },
                // Send token as form data
                data: {
                    __RequestVerificationToken: token,
                    id: brandId  // Explicitly send the ID
                },
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                success: function(response) {
                    console.log('Delete response:', response);

                    if (response.success) {
                        // Show success message
                        alert(response.message || 'Brand deleted successfully!');

                        // Remove from UI with fade animation
                        const row = document.querySelector(`tr[data-item-id="${brandId}"]`);
                        if (row) {
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';

                            setTimeout(() => {
                                row.remove();
                                updateSelectionUI();

                                // Check if table is now empty
                                if (document.querySelectorAll('.data-table tbody tr').length === 0) {
                                    showEmptyState();
                                }
                            }, 300);
                        }
                    } else {
                        // Show error message
                        alert(response.message || 'Error deleting brand.');

                        // Reset button
                        if (deleteBtn) {
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i><span class="desktop-text">Delete</span>';
                            deleteBtn.disabled = false;
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Delete error:', error);
                    console.error('Response:', xhr.responseText);
                    alert('Error deleting brand. Please check console for details.');

                    // Reset button
                    if (deleteBtn) {
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i><span class="desktop-text">Delete</span>';
                        deleteBtn.disabled = false;
                    }
                }
            });
        }

        /**
         * Deletes multiple selected brands after confirmation
         */
        function deleteSelectedBrands() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Please select at least one brand to delete.');
                return;
            }

            const brandIds = Array.from(selected).map(checkbox => checkbox.value);
            const count = selected.length;

            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete ${count} selected brand(s)?\n\nThis action cannot be undone.`)) {
                return;
            }

            // Show loading on delete button
            const deleteBtn = document.querySelector('#selectionActions .btn-danger');
            if (deleteBtn) {
                const originalHtml = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                deleteBtn.disabled = true;
            }

            // Get anti-forgery token
            const token = $('input[name="__RequestVerificationToken"]').val();

            // Send AJAX request for bulk deletion
            $.ajax({
                url: '/Admin/Brands/DeleteMultiple',
                type: 'POST',
                headers: {
                    'RequestVerificationToken': token,
                    'Content-Type': 'application/json'
                },
                // Send as JSON with IDs array
                data: JSON.stringify({
                    ids: brandIds,
                    __RequestVerificationToken: token
                }),
                success: function(response) {
                    console.log('Bulk delete response:', response);

                    if (response.success) {
                        // Show success message
                        alert(response.message || `${count} brand(s) deleted successfully!`);

                        // Remove selected rows from UI with fade animation
                        selected.forEach(checkbox => {
                            const row = checkbox.closest('tr');
                            if (row) {
                                row.style.transition = 'opacity 0.3s';
                                row.style.opacity = '0';

                                setTimeout(() => {
                                    row.remove();
                                }, 300);
                            }
                        });

                        // Clear selection and update UI
                        setTimeout(() => {
                            clearSelection();

                            // Check if table is now empty
                            if (document.querySelectorAll('.data-table tbody tr').length === 0) {
                                showEmptyState();
                            }
                        }, 400);
                    } else {
                        // Show error message
                        alert(response.message || 'Error deleting brands.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Bulk delete error:', error);
                    alert('Error deleting brands. Please try again.');
                },
                complete: function() {
                    // Reset button
                    if (deleteBtn) {
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i><span class="desktop-text">Delete</span>';
                        deleteBtn.disabled = false;
                    }
                }
            });
        }

        /**
         * Shows empty state when no brands exist
         */
        function showEmptyState() {
            const tbody = document.querySelector('.data-table tbody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-inbox fa-3x text-muted"></i>
                                <h4>No Brands Found</h4>
                                <p>Get started by creating your first brand.</p>
                                <a href="/admin/brands/create" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add First Brand
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        /**
         * Gets the anti-forgery token from the page
         * returns {string} The anti-forgery token value
         */
        function getAntiForgeryToken() {
            // Try to find the token in the page
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenElement) {
                return tokenElement.value;
            }

            // If not found, try to get it from the form
            const form = document.querySelector('form input[name="__RequestVerificationToken"]');
            if (form) {
                return form.value;
            }

            console.warn('Anti-forgery token not found');
            return '';
        }

        /**
         * Sets up AJAX to include anti-forgery token in all requests
         */
        $.ajaxSetup({
            beforeSend: function(xhr) {
                const token = getAntiForgeryToken();
                if (token) {
                    xhr.setRequestHeader('RequestVerificationToken', token);
                }
            }
        });

        // ===========================================================================
        // OTHER BRAND OPERATIONS
        // ===========================================================================

        /**
         * Exports selected brands (simulated)
         */
        function exportSelectedBrands() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Please select at least one brand to export.');
                return;
            }

            const brandIds = Array.from(selected).map(checkbox => checkbox.value);
            const count = selected.length;

            // Show loading
            const exportBtn = document.querySelector('#selectionActions .btn-secondary');
            const originalText = exportBtn ? exportBtn.innerHTML : '';

            if (exportBtn) {
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                exportBtn.disabled = true;
            }

            // Simulate export (you can implement actual export here)
            setTimeout(() => {
                alert(`Exporting ${count} selected brands...\nBrand IDs: ${brandIds.join(', ')}`);

                // Reset button
                if (exportBtn) {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }
            }, 1000);
        }

        /**
         * Exports all brands (simulated)
         */
        function exportAllBrands() {
            // Get all brand IDs from the table
            const allBrandIds = Array.from(document.querySelectorAll('.row-select')).map(cb => cb.value);

            if (allBrandIds.length === 0) {
                alert('No brands to export.');
                return;
            }

            alert(`Exporting all ${allBrandIds.length} brands...\nBrand IDs: ${allBrandIds.join(', ')}`);
        }

        /**
         * Refreshes the brands table
         */
        function refreshBrands() {
            // Show loading
            const refreshBtn = document.querySelector('.table-action:nth-child(3)');
            const originalText = refreshBtn ? refreshBtn.innerHTML : '';

            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                refreshBtn.disabled = true;
            }

            // Reload the page
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // ===========================================================================
        // SELECTION MANAGEMENT FUNCTIONS
        // ===========================================================================

        // Set to store selected item IDs
        let selectedItems = new Set();

        /**
         * Handles row selection when clicking on a table row
         * param {Event} event - The click event
         * param {HTMLElement} row - The table row element
         */
        function selectRow(event, row) {
            // Don't trigger selection if clicking on checkbox, action buttons, or links
            if (event.target.type === 'checkbox' ||
                event.target.closest('.row-actions') ||
                event.target.tagName === 'A') {
                return;
            }

            const checkbox = row.querySelector('.row-select');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelection(checkbox);
            }
        }

        /**
         * Updates the selection state when a checkbox changes
         * param {HTMLInputElement} checkbox - The checkbox element
         */
        function updateSelection(checkbox) {
            const itemId = checkbox.value;

            if (checkbox.checked) {
                selectedItems.add(itemId);
                checkbox.closest('tr').classList.add('selected');
            } else {
                selectedItems.delete(itemId);
                checkbox.closest('tr').classList.remove('selected');
                const selectAll = document.getElementById('selectAll');
                if (selectAll) selectAll.checked = false;
            }

            updateSelectionUI();
        }

        /**
         * Toggles selection of all rows
         * param {HTMLInputElement} selectAllCheckbox - The "select all" checkbox
         */
        function toggleSelectAll(selectAllCheckbox) {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                updateSelection(checkbox);
            });
        }

        /**
         * Updates the selection UI (counter and actions bar)
         */
        function updateSelectionUI() {
            const count = selectedItems.size;
            const selectedCountEl = document.getElementById('selectedCount');
            const actionsBar = document.getElementById('selectionActions');

            if (selectedCountEl) {
                selectedCountEl.textContent = count;
            }

            if (actionsBar) {
                if (count > 0) {
                    actionsBar.classList.add('active');
                } else {
                    actionsBar.classList.remove('active');
                }
            }
        }

        /**
         * Clears all selections
         */
        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.checked = false;
                cb.closest('tr')?.classList.remove('selected');
            });
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = false;
            updateSelectionUI();
        }

        // ===========================================================================
        // MOBILE FUNCTIONS
        // ===========================================================================

        /**
         * Checks if the device is mobile
         * returns {boolean} True if mobile, false otherwise
         */
        function isMobile() {
            return window.innerWidth <= 768;
        }

        /**
         * Shows/hides mobile hint based on screen size
         */
        document.addEventListener('DOMContentLoaded', function() {
            const mobileHint = document.querySelector('.mobile-scroll-hint');
            if (mobileHint && isMobile()) {
                mobileHint.style.display = 'block';
            }

            // Update on resize
            window.addEventListener('resize', function() {
                if (mobileHint) {
                    mobileHint.style.display = isMobile() ? 'block' : 'none';
                }
            });
        });
    </script>
}