@model List<Brand>
@{
    ViewBag.Title = "Brand Management";
    ViewBag.PageTitle = "Brands";
    ViewBag.Subtitle = "Manage product brands";
}

<!-- Mobile Table Hint (Visible only on mobile) -->
<div class="mobile-scroll-hint" style="display: none; background: #f1f5f9; padding: 8px; text-align: center; color: #64748b; font-size: 12px; border-radius: 6px; margin-bottom: 15px;">
    <i class="fas fa-arrows-left-right"></i> Swipe horizontally to view all columns
</div>

<!-- Page Header -->
<div class="page-header">
    <div>
        <h2>Product Brands</h2>
        <p class="page-subtitle">Manage brands for your products</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary">
            <i class="fas fa-filter"></i>
            <span class="desktop-text">Filter</span>
        </button>
        <!-- "Add Brand" button - Now links to create page -->
        <a href="/admin/brands/create" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span class="desktop-text">Add Brand</span>
        </a>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Brands</div>
            <div class="stat-icon">
                <i class="fas fa-copyright"></i>
            </div>
        </div>
        <div class="stat-value">18</div>
        <div class="stat-desc">+2 from last month</div>
        <div class="stat-trend trend-up">
            <i class="fas fa-arrow-up"></i> 11.1%
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Active Brands</div>
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="stat-value">15</div>
        <div class="stat-desc">Visible on website</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Featured Brands</div>
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
        </div>
        <div class="stat-value">8</div>
        <div class="stat-desc">Highlighted on homepage</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Products/Brand</div>
            <div class="stat-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
        </div>
        <div class="stat-value">69</div>
        <div class="stat-desc">Average products per brand</div>
    </div>
</div>

<!-- Brands Table -->
<div class="data-table-container">
    <div class="table-header">
        <h2>All Brands</h2>
        <div class="table-actions">
            <button class="table-action" onclick="exportAllBrands()">
                <i class="fas fa-file-export"></i>
                <span class="desktop-text">Export All</span>
            </button>
            <button class="table-action" onclick="window.print()">
                <i class="fas fa-print"></i>
                <span class="desktop-text">Print</span>
            </button>
            <button class="table-action" onclick="refreshBrands()">
                <i class="fas fa-sync-alt"></i>
                <span class="desktop-text">Refresh</span>
            </button>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                </th>
                <th data-sortable="true">Brand Name <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Products <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Status <i class="fas fa-sort"></i></th>
                <th data-sortable="true">Website <i class="fas fa-sort"></i></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var item in Model)
                {
                    <tr class="table-row" data-item-id="@item.Id" onclick="selectRow(event, this)">
                        <td>
                            <input type="checkbox" class="row-select" value="@item.Id" onchange="updateSelection(this)">
                        </td>
                        <td>
                            <div class="customer-name">@item.Name</div>
                            <div class="text-muted">@(item.Description ?? "No description")</div>
                        </td>
                        <td>
                            <span class="badge badge-primary">@(item.Products?.Count() ?? 0) products</span>
                        </td>
                        <td>
                            @if (item.Status == "Active")
                            {
                                <span class="status-dot dot-active"></span>
                            }
                            else
                            {
                                <span class="status-dot dot-inactive"></span>
                            }
                            <span class="mobile-text">@item.Status</span>
                        </td>
                        <td>
                            <div class="website-link">
                                @if (!string.IsNullOrEmpty(item.Website))
                                {
                                    <a href="@item.Website" target="_blank" onclick="event.stopPropagation()">
                                        @{
                                            // Safely display domain name
                                            if (!string.IsNullOrEmpty(item.Website) &&
                                            Uri.TryCreate(item.Website, UriKind.Absolute, out Uri uri))
                                            {
                                                @uri.Host
                                            }
                                            else
                                            {
                                                <span>Website</span>
                                            }
                                        }
                                    </a>
                                }
                                else
                                {
                                    <span class="text-muted">Not specified</span>
                                }
                            </div>
                        </td>
                        <td onclick="event.stopPropagation()">
                            <div class="row-actions">
                                <button class="row-action view" onclick="loadViewModal('@item.Id', event)">
                                    <i class="fas fa-eye"></i>
                                    <span class="desktop-text">View</span>
                                </button>
                                <button class="row-action edit" onclick="loadEditModal('@item.Id', event)">
                                    <i class="fas fa-edit"></i>
                                    <span class="desktop-text">Edit</span>
                                </button>
                                <button class="row-action delete" onclick="deleteBrand('@item.Id', '@item.Name.Replace("'", "\\'")')">
                                    <i class="fas fa-trash"></i>
                                    <span class="desktop-text">Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-inbox fa-3x text-muted"></i>
                            <h4>No Brands Found</h4>
                            <p>Get started by creating your first brand.</p>
                            <a href="/admin/brands/create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add First Brand
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Page navigation example ">
        <ul class="pagination d-flex justify-content-center">
            @if (ViewBag.currentPage > 1)
            {
                <li class="page-item"><a class="page-link" href="/admin/brands?page=@(ViewBag.currentPage - 1)">Previous</a></li>
            }

            @for (var i = 1; i <= ViewBag.totalHodsOfPage; i++)
            {
                if (i == ViewBag.currentPage)
                {
                    <li class="page-item active"><a class="page-link" href="https://localhost:7286/Admin/Brands?page=@i">@i</a></li>
                }
                else
                {
                    <li class="page-item"><a class="page-link" href="https://localhost:7286/Admin/Brands?page=@i">@i</a></li>
                }
            }
            @if (ViewBag.currentPage != ViewBag.totalHodsOfPage && Model.Any())
            {
                <li class="page-item"><a class="page-link" href="/admin/brands?page=@(ViewBag.currentPage + 1)">Next</a></li>
            }
        </ul>
    </nav>
</div>

<!-- Selection Actions Bar -->
<div class="selection-actions" id="selectionActions">
    <div class="selected-count">
        <span id="selectedCount">0</span> brands selected
    </div>
    <div class="selection-buttons">
        <button class="btn btn-secondary btn-sm" onclick="exportSelectedBrands()">
            <i class="fas fa-file-export"></i>
            <span class="desktop-text">Export</span>
        </button>
        <button class="btn btn-danger btn-sm" onclick="deleteSelectedBrands()">
            <i class="fas fa-trash"></i>
            <span class="desktop-text">Delete</span>
        </button>
        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
            <i class="fas fa-times"></i>
            <span class="desktop-text">Clear</span>
        </button>
    </div>
</div>

<!-- Keep View and Edit modals if you still want those as modals -->
<div id="brandModalContainer" class="modal" style="display: none;">
    <div class="modal-content">
        <!-- Content will be loaded dynamically via AJAX -->
    </div>
</div>

<style>
    /* Modal Backdrop */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    /* Modal Content */
    .modal-content {
        background: white;
        border-radius: 8px;
        width: 500px;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    /* Modal Header */
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

    .modal-close {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        font-size: 1.25rem;
        padding: 5px;
    }

        .modal-close:hover {
            color: #334155;
        }

    /* Modal Body */
    .modal-body {
        padding: 20px;
    }

    /* Modal Footer */
    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    /* Loading and error states */
    .modal-loading,
    .modal-error {
        padding: 40px;
        text-align: center;
        color: #64748b;
        font-size: 16px;
    }

    .modal-error {
        color: #dc2626;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
    }

        .empty-state i {
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h4 {
            margin: 10px 0;
            color: #475569;
        }

        .empty-state p {
            margin-bottom: 20px;
        }
</style>

@section Scripts {
    <script>
        // Initialize brand-specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Brands page loaded');
            initBrandsPage();
            setupModalEvents();
        });

        // Brand-specific functions
        function initBrandsPage() {
            // Add brand-specific event listeners
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    updateSelection(this);
                });
            });
        }

        // ==================== MODAL FUNCTIONS (FOR VIEW/EDIT) ====================
        // Keep these for View and Edit operations if you still want them as modals
        function loadEditModal(brandId, event) {
            if (event) event.stopPropagation();

            const modalContainer = document.getElementById('brandModalContainer');
            const modalContent = modalContainer.querySelector('.modal-content');
            modalContent.innerHTML = '<div class="modal-loading">Loading...</div>';
            modalContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Load Edit.cshtml with brand data
            $.ajax({
                url: '/Brands/Edit/' + brandId,
                type: 'GET',
                success: function(response) {
                    const tempDiv = $('<div>').html(response);
                    if (tempDiv.find('.modal-header').length > 0) {
                        modalContent.innerHTML = response;
                    } else {
                        const modalHtml = tempDiv.find('#brandModalContainer').html() || response;
                        modalContent.innerHTML = modalHtml;
                    }
                    setupModalEvents();
                    attachEditFormHandlers();
                },
                error: function() {
                    modalContent.innerHTML = '<div class="modal-error">Error loading form. Please try again.</div>';
                }
            });
        }

        function loadViewModal(brandId, event) {
            if (event) event.stopPropagation();

            const modalContainer = document.getElementById('brandModalContainer');
            const modalContent = modalContainer.querySelector('.modal-content');
            modalContent.innerHTML = '<div class="modal-loading">Loading...</div>';
            modalContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Load Details.cshtml
            $.ajax({
                url: '/Brands/Details/' + brandId,
                type: 'GET',
                success: function(response) {
                    const tempDiv = $('<div>').html(response);
                    if (tempDiv.find('.modal-header').length > 0) {
                        modalContent.innerHTML = response;
                    } else {
                        const modalHtml = tempDiv.find('#brandModalContainer').html() || response;
                        modalContent.innerHTML = modalHtml;
                    }
                    setupModalEvents();
                },
                error: function() {
                    modalContent.innerHTML = '<div class="modal-error">Error loading brand details.</div>';
                }
            });
        }

        function closeModal() {
            const modalContainer = document.getElementById('brandModalContainer');
            if (modalContainer) {
                modalContainer.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function setupModalEvents() {
            const modalContainer = document.getElementById('brandModalContainer');
            if (!modalContainer) return;

            // Close on backdrop click
            modalContainer.addEventListener('click', function(e) {
                if (e.target === this || e.target.closest('.modal-close')) {
                    closeModal();
                }
            });

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modalContainer.style.display === 'flex') {
                    closeModal();
                }
            });

            // Prevent clicks inside modal content from closing modal
            const modalContent = modalContainer.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        function attachEditFormHandlers() {
            // Handle edit form submission
            const editForm = document.getElementById('editBrandForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    $.ajax({
                        url: this.action,
                        type: 'POST',
                        data: $(this).serialize(),
                        success: function(response) {
                            if (response.success) {
                                closeModal();
                                window.location.reload();
                            } else {
                                // Replace form with validation errors
                                const modalContent = document.querySelector('#brandModalContainer .modal-content');
                                modalContent.innerHTML = response;
                                attachEditFormHandlers();
                            }
                        },
                        error: function() {
                            alert('Error saving brand. Please try again.');
                        }
                    });
                });
            }
        }

        // ==================== BRAND OPERATIONS ====================
        function deleteBrand(brandId, brandName) {
            if (confirm(`Are you sure you want to delete "${brandName}"? This action cannot be undone.`)) {
                console.log('Deleting brand:', brandId);
                // Remove from UI
                const row = document.querySelector(`tr[data-item-id="${brandId}"]`);
                if (row) row.remove();
                updateSelectionUI();
            }
        }

        // Bulk actions for brands
        function deleteSelectedBrands() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Please select at least one brand');
                return;
            }

            if (confirm(`Delete ${selected.length} selected brands?`)) {
                selected.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    if (row) row.remove();
                });
                clearSelection();
            }
        }

        function exportSelectedBrands() {
            const selected = document.querySelectorAll('.row-select:checked');
            if (selected.length === 0) {
                alert('Please select at least one brand');
                return;
            }
            alert(`Exporting ${selected.length} selected brands...`);
        }

        function exportAllBrands() {
            alert('Exporting all brands...');
        }

        function refreshBrands() {
            alert('Refreshing brands data...');
        }

        // ==================== SELECTION FUNCTIONS ====================
        let selectedItems = new Set();

        function selectRow(event, row) {
            if (event.target.type === 'checkbox' ||
                event.target.closest('.row-actions') ||
                event.target.tagName === 'A') {
                return;
            }

            const checkbox = row.querySelector('.row-select');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelection(checkbox);
            }
        }

        function updateSelection(checkbox) {
            const itemId = checkbox.value;

            if (checkbox.checked) {
                selectedItems.add(itemId);
                checkbox.closest('tr').classList.add('selected');
            } else {
                selectedItems.delete(itemId);
                checkbox.closest('tr').classList.remove('selected');
                const selectAll = document.getElementById('selectAll');
                if (selectAll) selectAll.checked = false;
            }

            updateSelectionUI();
        }

        function toggleSelectAll(selectAllCheckbox) {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                updateSelection(checkbox);
            });
        }

        function updateSelectionUI() {
            const count = selectedItems.size;
            const selectedCountEl = document.getElementById('selectedCount');
            const actionsBar = document.getElementById('selectionActions');

            if (selectedCountEl) {
                selectedCountEl.textContent = count;
            }

            if (actionsBar) {
                if (count > 0) {
                    actionsBar.classList.add('active');
                } else {
                    actionsBar.classList.remove('active');
                }
            }
        }

        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.checked = false;
                cb.closest('tr')?.classList.remove('selected');
            });
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = false;
            updateSelectionUI();
        }

        // ==================== MOBILE FUNCTIONS ====================
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Show mobile hint
        document.addEventListener('DOMContentLoaded', function() {
            const mobileHint = document.querySelector('.mobile-scroll-hint');
            if (mobileHint && isMobile()) {
                mobileHint.style.display = 'block';
            }

            // Update on resize
            window.addEventListener('resize', function() {
                if (mobileHint) {
                    mobileHint.style.display = isMobile() ? 'block' : 'none';
                }
            });
        });
    </script>
}